name: zodgame

on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    # --- ğŸ”§ ä¿®å¤æ ¸å¿ƒï¼šæŒ‡å®š Python 3.11 (é¿å… 3.12 ç¼ºå°‘ distutils å¯¼è‡´æŠ¥é”™) ---
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' 
    
    - name: Install requirements
      run: |
        pip3 install -r ./zodgame/requirements.txt
        
    - name: Run
      run: |
        python3 ./zodgame/zodgame.py "${{secrets.ZODGAME_COOKIE}}"

    # --- âœ… æˆåŠŸé€šçŸ¥ (PowerShell è§£å†³ä¹±ç ) ---
    - name: Send Gotify Notification on Success
      if: success()
      shell: pwsh
      run: |
        $params = @{
            title    = "ZodGame ç­¾åˆ°æˆåŠŸ"
            message  = "æ¯æ—¥ç­¾åˆ°ä»»åŠ¡å·²æˆåŠŸå®Œæˆã€‚"
            priority = 5
        }
        $url = "${{ secrets.GOTIFY_URL }}/message?token=${{ secrets.GOTIFY_TOKEN }}"
        Invoke-RestMethod -Uri $url -Method Post -Body $params

    # --- ğŸš¨ å¤±è´¥é€šçŸ¥ (PowerShell è§£å†³ä¹±ç ) ---
    - name: Send Gotify Notification on Failure
      if: failure()
      shell: pwsh
      run: |
        $params = @{
            title    = "ZodGame ç­¾åˆ°å¤±è´¥"
            message  = "è„šæœ¬æ‰§è¡Œå‡ºé”™ï¼Œè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ã€‚"
            priority = 8
        }
        $url = "${{ secrets.GOTIFY_URL }}/message?token=${{ secrets.GOTIFY_TOKEN }}"
        Invoke-RestMethod -Uri $url -Method Post -Body $params

    - uses: liskin/gh-workflow-keepalive@main
